<!doctype html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,user-scalable=no,shrink-to-fit=no">
    <base href="https://amdouglas.com/">
    <title>Why the New fetch API is Broken · A. M. Douglas · Leeds, UK</title>
    <link rel="manifest" href="https://amdouglas.com/manifest.json">
    <link rel="prefetch" href="https://amdouglas.com/assets/fonts/Rubik-Regular.woff">
    <link rel="prefetch" href="https://amdouglas.com/assets/fonts/Rubik-Bold.woff">
    <link rel="prefetch" href="https://amdouglas.com/assets/fonts/Rubik-Regular.woff2">
    <link rel="prefetch" href="https://amdouglas.com/assets/fonts/Rubik-Bold.woff2">
    <link rel="canonical" href="https://amdouglas.com/blog/why-the-new-fetch-api-is-broken/">
    <link rel="publisher" href="https://plus.google.com/+AMDouglasCom">
    <link rel="icon" href="https://amdouglas.com/favicon.ico">
    <meta name="format-detection" content="telephone=no;email=no">
    <meta name="MobileOptimized" content="width">
    <meta name="HandheldFriendly" content="true">
    <meta name="referrer" content="origin">
    <meta name="description" content="There is probably no DOM API more loathed than the XMLHttpRequest, but is the hatred really justified? It probably was when web browsers did not implement it consistently...">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:creator" content="A. M. Douglas">
    <meta name="twitter:url" content="https://amdouglas.com/blog/why-the-new-fetch-api-is-broken/">
    <meta name="twitter:domain" content="amdouglas.com">
    <meta name="twitter:title" content="Why the New fetch API is Broken">
    <meta name="twitter:description" content="There is probably no DOM API more loathed than the XMLHttpRequest, but is the hatred really justified? It probably was when web browsers did not implement it consistently...">
    <meta name="twitter:image:src" content="https://amdouglas.com/assets/img/favicon-196x196.png">
    <meta property="fb:admins" content="407402372749613">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="A. M. Douglas">
    <meta property="og:title" content="Why the New fetch API is Broken">
    <meta property="og:description" content="There is probably no DOM API more loathed than the XMLHttpRequest, but is the hatred really justified? It probably was when web browsers did not implement it consistently...">
    <meta property="og:locale" content="en_GB">
    <meta property="og:url" content="https://amdouglas.com/blog/why-the-new-fetch-api-is-broken/">
    <meta property="og:image" content="https://amdouglas.com/assets/img/favicon-196x196.png">
    <meta property="og:image:secure_url" content="https://amdouglas.com/assets/img/favicon-196x196.png">
    <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
    <style>
      html{-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased;-webkit-font-smoothing:subpixel-antialiased;-webkit-tap-highlight-color:rgba(0,0,0,0);-webkit-overflow-scrolling:touch;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;touch-action:manipulation;font:normal normal 400 16px/1.2 Roboto,-apple-system,Arial,Helmet,Freesans,sans-serif}html,body{height:100%}*,:before,:after{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;touch-action:manipulation;margin:0;padding:0;border:0;font:inherit}:active,:focus{outline:0}article,footer,header,main,nav,section,video{display:block}a{-webkit-text-decoration-skip:objects;text-decoration:none}button,input,textarea{-webkit-appearance:none;-webkit-border-radius:0;border-radius:0;background:0 0}button,img,video{-webkit-touch-callout:none}button,a,img,video{-webkit-user-select:none;-moz-user-select:none}button,a{color:inherit;cursor:pointer}textarea{resize:none}[disabled]{opacity:.6;cursor:not-allowed}[hidden],video::-webkit-media-controls,video::-webkit-media-controls-play-button,video::-webkit-media-controls-volume-slider,video::-webkit-media-controls-mute-button,video::-webkit-media-controls-timeline,video::-webkit-media-controls-current-time-display{display:none}::-webkit-scrollbar{width:0}::-webkit-scrollbar-thumb{background:#07071c}::-webkit-scrollbar-track{background-color:transparent;background:rgba(0,0,0,0)}::selection{background:#07071c;color:#fff}::-moz-selection{background:#07071c;color:#fff}
    </style>
  </head>
  <body>
    <main>
      <header>
        <a href="https://amdouglas.com/">A. M. Douglas</a>
      </header>
      <nav>
        <a href="https://amdouglas.com/">Home</a> &bull;
        <a href="https://amdouglas.com/blog/">Archive</a>
      </nav>
      <article>
        <h1>Why the New fetch API is Broken</h1>
        <section>
          <p>There is probably no DOM API more loathed than the <code>XMLHttpRequest</code>, but is the hatred really justified? It probably was when web browsers did not implement it consistently, but these days you can pretty much get by with the same code in every browser. A <code>GET</code> request might look something like this:</p>
          <pre>
            <code>
var xhr = new XMLHttpRequest();

xhr.open( 'GET', url );

xhr.onreadystatechange = function(){
  if ( this.readyState === )
  {
    if ( 4 &amp;&amp; this.status &gt;= 200 &amp;&amp; this.status &lt; 300 )
    {
      // do stuff;
    }
  }
};

xhr.onabort = xhr.onerror = function(){
  console.info( 'There was an error with the request' );
};

xhr.send();
            </code>
          </pre>
          <p>That will more or less work anywhere. And it's not particularly horrific to look at. It's certainly not pretty, but it used to be much worse in the ActiveX days.</p>
          <h3>Enter fetch</h3>
          <p>Now there's a new kid in town—<a href="https://fetch.spec.whatwg.org/">the fetch API</a>—and, looking at that spec, web developers around the world should be rejoicing. Finally, something that looks like jQuery but in vanilla JavaScript, thank goodness!</p>
          <p>But we're not rejoicing. At least, I'm not, and I've noted a number of others not particularly happy with the new kid. Despite many articles hailing it as the future, and others <a href="https://developers.google.com/web/updates/2015/03/introduction-to-fetch?hl=en">waving XHR goodbye</a> The first and foremost complaint is the fact that it is Promise-based, <a href="https://github.com/whatwg/fetch/issues/20">and thus does not presently offer any means of aborting a request</a>. This issue is plain to see, and will probably be fixed (one day).</p>
          <p>I take issue with something just as fundamental: it leads to ugly code and offers less power than XHR2.</p>
          <h3>The case against fetch</h3>
          <p>Let's look at that XHR code again. If I wanted to use that snippet to get another page of my website and load it into the current document, replacing the old page and effectively loading the new page without a full browser refresh, I could obviously parse the response using the HTML parser built into the vanilla DOM, but this wouldn't be necessary thanks to the XHR2 spec, which includes the ability to set a response type. Thus, in order to get a document which can be <code>querySelector</code>'d and so on, all we have to add is this:</p>
          <pre>
            <code>
xhr.responseType = 'document';
            </code>
          </pre>
          <p>Very, very simple.</p>
          <p>Fast-forward to the fetch API. The same code looks like this:</p>
          <pre>
            <code>
fetch( url, {
  method: 'GET',
  headers: { 'Content-Type' : 'text/html' },
  mode: 'same-origin'
}).then( function( response ){

  if ( response.ok){
    var contentType = response.headers.get( 'Content-Type' );

    if( contentType &amp;&amp; contentType.indexOf( 'text/html' ) !== -1 ){
      return response.text().then( function( resptxt ){

        var parser = new DOMParser(),
            doc = parser.parseFromString( resptxt, 'text/html' );

        // do something with the new document

      }).catch( function(){
        console.info( 'Error: No HTML received' )
      });
    }
  }
}).catch( function( response ){
  console.info( 'Error: ' + response.message )
});
            </code>
          </pre>
          <p>Your eyes do not deceive you: the fetch API actually leads to more verbose code. Here I have to manually set a content type checker, resolve the text from the response Promise and parse the text with the DOM API! It's absurd!</p>
          <h3>Why fetch then?</h3>
          <p>Ultimately, this is because the fetch API, despite having poor browser support, is actually more low-level than XHR. XHR is to be defined in fetch in the end, and such things as <code>xhr.responseType = 'document'</code> will probably be defined in much the same way as I have outlined.</p>
          <p>This does of course invite the question of when to actually use fetch. The use cases become clear when you consider streaming (fetch responses are Stream objects, and are thus asynchronous by nature) and Service Workers.</p>
          <p>Like many low-level APIs, you should stick to using XHR2 unless there's something you specifically need from the fetch API like streams.</p>
          <p><span class="cursor">&#9608;</span></p>
        </section>
        <footer>
          <a href="https://amdouglas.com/blog/lazyloading-css-background-images/">
            <header>Up next</header>
            <section>
              <h4>Lazyloading CSS Background Images</h4>
              <p>As a rule, I generally prefer, for the purposes of accessibility and SEO, to use IMG elements to display images over the background-image approach...</p>
              <hr>
              <p><time datetime="2016-08-20 21:35">20 August 2016</time></p>
            </section>
          </a>
          <a href="https://amdouglas.com/blog/autoform-js/">
            <header>Previously</header>
            <section>
              <h4>Labs: autoform.js</h4>
              <p>autoform.js is a vanilla (i.e. no jQuery) JavaScript library which looks for HTML forms in the DOM and automatically handles the submit event via AJAX.</p>
              <hr>
              <p><time datetime="2016-08-14 22:49">14 August 2016</time></p>
            </section>
          </a>
        </footer>
      </article>
    </main>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "NewsArticle",
        "mainEntityOfPage": "https://amdouglas.com/blog/why-the-new-fetch-api-is-broken/",
        "headline": "Why the New fetch API is Broken",
        "datePublished": "2016-08-18T20:59:02+00:00",
        "dateModified": "2016-08-18T20:59:02+00:00",
        "description": "There is probably no DOM API more loathed than the XMLHttpRequest, but is the hatred really justified? It probably was when web browsers did not implement it consistently...",
        "author": {
          "@type": "Person",
          "name": "A. M. Douglas"
        },
        "publisher": {
          "@type": "Organization",
          "name": "A. M. Douglas",
          "logo": {
            "@type": "ImageObject",
            "url": "https://amdouglas.com/assets/img/apple-touch-icon-60x60.png",
            "width": 60,
            "height": 60
          }
        },
        "image": {
          "@type": "ImageObject",
          "url": "https://amdouglas.com/assets/img/apple-touch-icon-60x60.png",
          "height": 60,
          "width": 60
        }
      }
    </script>
    <!--[if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script><![endif]--><!--[if IE]><script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/2014.01.31/classList.min.js"></script><![endif]-->
    <script async defer src="https://amdouglas.com/assets/js/article.js"></script>
  </body>
</html>
