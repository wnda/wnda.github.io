<!doctype html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,user-scalable=no,shrink-to-fit=no">
    <base href="https://amdouglas.com/">
    <title>Stripe Custom Form in Vanilla JS · A. M. Douglas · Leeds, UK</title>
    <link rel="manifest" href="https://amdouglas.com/manifest.json">
    <link rel="prefetch" href="https://amdouglas.com/assets/fonts/Rubik-Regular.woff">
    <link rel="prefetch" href="https://amdouglas.com/assets/fonts/Rubik-Bold.woff">
    <link rel="prefetch" href="https://amdouglas.com/assets/fonts/Rubik-Regular.woff2">
    <link rel="prefetch" href="https://amdouglas.com/assets/fonts/Rubik-Bold.woff2">
    <link rel="canonical" href="https://amdouglas.com/blog/stripe-custom-form-in-vanilla-js/">
    <link rel="publisher" href="https://plus.google.com/+AMDouglasCom">
    <link rel="icon" href="https://amdouglas.com/favicon.ico">
    <meta name="format-detection" content="telephone=no;email=no">
    <meta name="MobileOptimized" content="width">
    <meta name="HandheldFriendly" content="true">
    <meta name="referrer" content="origin">
    <meta name="description" content="Given that it's coming up to Christmas, there obviously couldn't be a more appropriate time to think about adding or customising an e-commerce experience with your own take on the Stripe form">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:creator" content="A. M. Douglas">
    <meta name="twitter:url" content="https://amdouglas.com/blog/stripe-custom-form-in-vanilla-js/">
    <meta name="twitter:domain" content="amdouglas.com">
    <meta name="twitter:title" content="Stripe Custom Form in Vanilla JS">
    <meta name="twitter:description" content="Given that it's coming up to Christmas, there obviously couldn't be a more appropriate time to think about adding or customising an e-commerce experience with your own take on the Stripe form">
    <meta name="twitter:image:src" content="https://amdouglas.com/assets/img/favicon-196x196.png">
    <meta property="fb:admins" content="407402372749613">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="A. M. Douglas">
    <meta property="og:title" content="Stripe Custom Form in Vanilla JS">
    <meta property="og:description" content="Given that it's coming up to Christmas, there obviously couldn't be a more appropriate time to think about adding or customising an e-commerce experience with your own take on the Stripe form">
    <meta property="og:locale" content="en_GB">
    <meta property="og:url" content="https://amdouglas.com/blog/stripe-custom-form-in-vanilla-js/">
    <meta property="og:image" content="https://amdouglas.com/assets/img/favicon-196x196.png">
    <meta property="og:image:secure_url" content="https://amdouglas.com/assets/img/favicon-196x196.png">
    <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
    <style>
      html{-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased;-webkit-font-smoothing:subpixel-antialiased;-webkit-tap-highlight-color:rgba(0,0,0,0);-webkit-overflow-scrolling:touch;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;touch-action:manipulation;font:normal normal 400 16px/1.2 Roboto,-apple-system,Arial,Helmet,Freesans,sans-serif}html,body{height:100%}*,:before,:after{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;touch-action:manipulation;margin:0;padding:0;border:0;font:inherit}:active,:focus{outline:0}article,footer,header,main,nav,section,video{display:block}a{-webkit-text-decoration-skip:objects;text-decoration:none}button,input,textarea{-webkit-appearance:none;-webkit-border-radius:0;border-radius:0;background:0 0}button,img,video{-webkit-touch-callout:none}button,a,img,video{-webkit-user-select:none;-moz-user-select:none}button,a{color:inherit;cursor:pointer}textarea{resize:none}[disabled]{opacity:.6;cursor:not-allowed}[hidden],video::-webkit-media-controls,video::-webkit-media-controls-play-button,video::-webkit-media-controls-volume-slider,video::-webkit-media-controls-mute-button,video::-webkit-media-controls-timeline,video::-webkit-media-controls-current-time-display{display:none}::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:#07071c}::-webkit-scrollbar-track{background-color:transparent;background:rgba(0,0,0,0)}::selection{background:#07071c;color:#fff}::-moz-selection{background:#07071c;color:#fff}
    </style>
    <noscript>
      <link rel="stylesheet" href="https://amdouglas.com/assets/css/fonts.css">
      <link rel="stylesheet" href="https://amdouglas.com/assets/css/article.css">
    </noscript>
  </head>
  <body>
    <main>
      <header>
        <a href="https://amdouglas.com/">A. M. Douglas</a>
      </header>
      <nav>
        <a href="https://amdouglas.com/">Home</a> &bull;
        <a href="https://amdouglas.com/blog/">Archive</a>
      </nav>
      <article>
        <h1>Stripe Custom Form in Vanilla JS</h1>
        <section>
          <p>Given that it's coming up to Christmas, there obviously couldn't be a more appropriate time to think about adding or customising an e-commerce experience with your own take on <a href="https://stripe.com" title="Stripe Payment Gateway">the Stripe form</a>.</p>
          <h4>Before you go any further</h4>
          <p>This article will be pretty long, as I will narrate the general process of responsibly creating forms in general, so if you a skip-to-the-end kind of person, you can find the <a href="https://github.com/wnda/stripe-custom">source code here</a> and the <a href="https://amdouglas.com/pay">live payment form here</a>.</p>
          <p>Please also note that I will be demonstrating the server-side controller for a custom Stripe form in a hypothetical <strong>Node/Express</strong> web application using vanilla JavaScript on the front-end. So, if you like jQuery, or if you are just looking for an API reference for a Ruby, PHP or Go app, you can find official documentation <a href="https://stripe.com/docs/tutorials/forms">about</a> <a href="https://stripe.com/docs/api">both</a> at the Stripe website.</p>
          <p>Finally, if you're a Perl developer, I may in the future do a write-up on implementing Stripe with Perl, but for the moment I'm waiting to see whether it will be Perl 5 or Perl 6 that I will be using for that.</p>
          <h4>So, why a custom form?</h4>
          <p>You might ask why anybody would want to do this, since the Stripe payment widget loaded via iFrame is a pretty damn well-engineered piece of kit, helps you circumvent an otherwise expensive PCI Compliance audit, and saves you the trouble of styling your payment form.</p>
          <p>Here are the reasons I wanted to create a customised experience:</p>
          <ul>
            <li>The default Stripe Checkout widget does not support variable payment amounts</li>
            <li>It's also widget is kind of heavy</li>
            <li>It looks great, like it was plucked out of OS X, but the gradients and solid theme might clash with your website/app's UI (as it does with mine)</li>
            <li>You may just want an exercise with your afternoon tea</li>
          </ul>
          <h4>Preamble: why Stripe?</h4>
          <p>Stripe is an innovative piece of kit, primarily because of how easy it is to work with for developers like myself&mdash;and also for its simple pricing model. Granted, it's not the cheapest, but what you lose in the slightly higher transaction fees is more than compensated by the removal of headaches. </p>
          <p>Considering other payment gateways offering easy PCI Compliance, SagePay's iFrame is a trusty mule, but it's a bit ugly, and implementing a customised experience is not as easy. You also need a merchant account and you need to pay a flat fee of £25 per month, so Stripe's model of paying more, but only when you use their service, is instantly more attractive to startup companies and fledgling freelancers.</p>
          <p>Paypal I do not even consider these days unless it's specifically requested by a client, and even then, I just try to persuade them of the benefits of Stripe or SagePay. Paypal is simple to setup, but presents one of two unpleasant issues.</p>
          <ul>
            <li>Either you use a generic button, direct the customer to Paypal and implement an IPN listener or</li>
            <li>Credit card info gets passed to your server at some point&mdash;bye bye PCI Compliance.</li>
          </ul>
          <p>Perhaps the most important advantage Stripe offers is the pleasantly surprising policy on international transactions and American Express: no additional fees are levied, making it a very good idea for businesses targeting multiple countries.</p>
          <p>A final benefit: Stripe is one of the few payment gateways who will migrate your subscribers (should you have subscribers) to an alternative provider on your behalf.</p>
          <h4>Prerequisites</h4>
          <ul>
            <li>
              A text editor
            </li>
            <li>
              A web browser
            </li>
            <li>
              A server
            </li>
            <li>
              A web application
            </li>
            <li>
              An SSL certificate and an encrypted connection to your web application
            </li>
          </ul>
          <h4>Getting started</h4>
          <p>A mistake many developers make is that they think <strong>Stripe</strong> is an entirely client-side solution to the problem of payments, and are suddenly overwhelmed to discover that some server-side logic must be established to fulfil the payments that are only initiated by the client-side library. Fortunately, the Stripe team provide robust server-side libraries as well.</p>
          <p>Creating a custom form really couldn't be much simpler, but for those who prefer to have some actual instructions on implementation, the client-side code is only provided with a strong dependence on jQuery and for fixed-amount payments. jQuery is a truly great library and, for a long time, most developers would have been foolish not to leverage its cross-browser compatibility features. </p>
          <p>Now we're in 2016, the issue of cross-browser JavaScript portability is no longer critical (as long as you don't care about IE8&mdash;which you shouldn't since even Microsoft has officially discontinued support for it) jQuery represents little more than needless overheard. Some things are still simpler to do, sure, but the cost to operations per second is no longer justified, especially not on mobile.</p>
          <p>Given that we want to allow our customer to pay-what-they-want, and given that we also do not want to use a needless and arguably heavy library, we will need to come up with our own variation. Fortunately, the JavaScript code doesn't really look much different to the jQuery code in the end until you reach the point where you want to interrupt the form submission and subsequently XHR the form to your server along with the StripeToken.</p>
          <p>Let us begin by understanding what Stripe does.</p>
          <h4>How Stripe works</h4>
          <p>Stripe helps developers and businesses avoid headaches about PCI compliance by preventing sensitive data from ever touching the vendor's server. The data is handled by Stripe's iFrame which returns a one-way encrypted token by which transactions are identified and processed by server-side business logic. Beautiful and simple to work with.</p>
          <p>Perhaps the real beauty, however, is in the flexibility of the Stripe payment gateway. You have two options. Firstly, there's <strong>Stripe Checkout</strong>, which loads a widget in an iFrame much like SagePay's form integration solution, though a good deal prettier. Secondly, there's <strong>Stripe.js</strong>, which gives you the power to implement your own payment form while still levying the <strong>Checkout</strong> widget's strengths&mdash;like the validator functions, which very reliably check the authenticity of credit card numbers on the client-side (enabling good UX) while at the same time not checking those numbers against anything on your server.</p>
          <p>Stripe.js is designed to intercept your payment form, pass the credit card details to Stripe's servers, process the payment and return a token which is used to authorise the payment and charge the card from your web application. </p>
          <h4>The Payment Form</h4>
          <p>Yes, unsurprisingly, the first thing we need is a payment form. It will initially look something like this:</p>
          <pre>
            <code>
&lt;form method="POST" action="/pay-controller"&gt;
  &lt;fieldset&gt;
    &lt;div class="field"&gt;
      &lt;label&gt;
        &lt;input type="email" id="email"&gt;
      &lt;/label&gt;
    &lt;/div&gt;
  &lt;/fieldset&gt;
  &lt;fieldset&gt;
    &lt;div class="field"&gt;
      &lt;label&gt;
        &lt;input type="text" id="card-number"&gt;
      &lt;/label&gt;
    &lt;/div&gt;
    &lt;div class="field"&gt;
      &lt;label&gt;
        &lt;input type="text" id="cvc-number"&gt;
      &lt;/label&gt;
    &lt;/div&gt;
    &lt;div class="field"&gt;
      &lt;label&gt;
        &lt;input type="text" id="exp-month"&gt;
      &lt;/label&gt;
    &lt;/div&gt;
    &lt;div class="field"&gt;
      &lt;label&gt;
        &lt;input type="text" id="exp-year"&gt;
      &lt;/label&gt;
    &lt;/div&gt;
  &lt;/fieldset&gt;
  &lt;button type="submit" class="btnpay"&gt;Pay&lt;/button&gt;
&lt;/form&gt;
            </code>
          </pre>
          <p>You could have a more bare-bones form, but chances are you'll end up using <code>div</code> elements to give you control over the <code>input</code> sizing and layout. You may also have noticed the fact that I am wrapping <code>input</code> fields in <code>labels</code> rather than the arguably preferable use of the <code>for=</code> attribute on <code>labels</code>. This is, however, a necessity, as we shall see shortly.</p>
          <p>The <code>form</code> <code>action</code> is left blank in a lot of Stripe's examples, but you want to point this to the route of your controller which is going to charge the credit card.</p>
          <p>So, when the customer fills out this form, we need to pass the credit card details to Stripe, receive the Stripe token and then resubmit the form including the token. This is pretty straightforward if you've ever used a <code>POST</code> request to pass url-encoded data to a server via <code>XMLHttpRequest</code> before. For those of you who have not, I will cover it extensively so fear not.</p>
          <p>Before we go any further, however, we need to change this form a little. We obviously want to validate the form on the client-side for a good user experience, though Stripe itself will validate any payment sent to its API for processing, and we will obviously include server-side validation as well. We want the price to be flexible (but greater than 0) and let's say that we want the customer's email address as well so we can mail out basic payment confirmation message. Our form then should look more like this:</p>
          <pre>
            <code>
&lt;form method="POST" action="/pay-controller"&gt;
  &lt;fieldset&gt;
    &lt;div class="field"&gt;
      &lt;label&gt;
        &lt;input type="email" id="email" name="email" required&gt;
      &lt;/label&gt;
    &lt;/div&gt;
    &lt;div class="field"&gt;
      &lt;label&gt;
        &lt;input type="number" id="price-gbp" pattern="[1-9]\d*" required&gt;
      &lt;/label&gt;
      &lt;input type="hidden" id="price-pennies" name="amount"&gt;
    &lt;/div&gt;
  &lt;/fieldset&gt;
  &lt;fieldset&gt;
    &lt;div class="field"&gt;
      &lt;label&gt;
        &lt;input type="text" id="card-number" pattern="[0-9]{13,16}" maxlength="16" required&gt;
      &lt;/label&gt;
    &lt;/div&gt;
    &lt;div class="field"&gt;
      &lt;label&gt;
        &lt;input type="text" id="cvc-number" pattern="[0-9]{3,3}" maxlength="3" required&gt;
      &lt;/label&gt;
    &lt;/div&gt;
    &lt;div class="field"&gt;
      &lt;label&gt;
        &lt;input type="text" id="exp-month" pattern="0[1-9]|1[012]" maxlength="2" required&gt;
      &lt;/label&gt;
    &lt;/div&gt;
    &lt;div class="field"&gt;
      &lt;label&gt;
        &lt;input type="text" id="exp-year" pattern="[0-9]{4,4}" maxlength="4" required&gt;
      &lt;/label&gt;
    &lt;/div&gt;
  &lt;/fieldset&gt;
  &lt;button type="submit" class="btnpay"&gt;Pay&lt;/button&gt;
&lt;/form&gt;
            </code>
          </pre>
          <p>HTML5 <code>input</code> elements have come a long way, but there is still some inconsistency in which attributes really work in terms of validation. The most effective ones I have tested are <code>required</code> (obvious), and <code>pattern</code>&mdash;which allows you to supply a regular expression to test the <code>input</code> values entered by the customer, without JavaScript and in real-time, without additional libraries and event listeners. That said, in production you will want something more robust which will block form submission in browsers which do not honor the <code>required</code> or <code>pattern</code> attributes.</p>
          <p>Note how there is now <code>pattern</code> attribute specified for the <code>input type="email"</code>&mdash;this is because the email type automatically feeds this field with an implicit pattern which is more effective and reliable than any regular expression you could supply in a pattern attribute. The same applies to the <code>number</code> type <code>input</code>, which will not accept letters and will prompt mobile users with the number keypad rather than the keyboard. </p>
          <p>Personally, I don't consider this good user experience (text <code>input</code> is always nicer to use) but for the sake of making things easier a bit later, we'll roll with this for now. <a href="http://html5pattern.com/Miscs" title="HTML5 input regex validation patterns">If you want price formatting, there are some good patterns available at html5pattern.com</a>.</p>
          <p>The other <code>input</code> fields have been fielded with patterns and max-lengths to prevent 60-character CVCs&mdash;which can be confusing for the user, since some gauge the validity of their own responses according to when the input fields restrict further input. You might wonder why I am not specifying a <code>minlength</code> attribute&mdash;this is because <a href="http://caniuse.com/#search=minlength">support for <code>minlength</code> is limited to Chrome and other Blink-based web browsers</a>, whereas <a href="http://caniuse.com/#search=pattern">support for <code>pattern</code> is remarkably good</a>. Patterns are elegant because they allow you to validate both format and length, but we still specify <code>maxlength</code> because:</p>
          <ul>
            <li>support for <code>maxlength</code> is all but universal</li>
            <li><code>pattern</code> does not restrict how long an entry can be in an input field, where <code>maxlength</code> does in most browsers</li>
          </ul>
          <p>The whole point of these validation attributes rather than just importing a massive library? Firstly, to optimise for the future. One day, support will be comprehensive and the need for downloading a couple of form validation libraries will be a distant memory. Secondly, Stripe.js will perform the critical validations when we interrupt the form's submission.</p>
          <p>Finally, note where <code>name</code> attributes have been included and where they have not. If you've worked with forms before, you will know that <code>input</code> elements specifying a <code>name</code> will supply their input values as url-encoded data in the <code>HTTP POST</code> ready to be retrieved by your server. We want to catch the price entered by the customer, as well as their email address, so we give these input fields appropriate names. Crucially, we do not give names to the input fields which will bear credit card data, as this would cause that data to be posted to your server and our mission to achieve easy PCI compliance would fail rather abruptly.</p>
          <h4>The Import</h4>
          <p>Now we have a form, we can start building the application code. First, before anything else and probably best in the <code>&lt;head&gt;</code>, import the Stripe.js client-side library and immediately after set your publishable key.</p>
          <pre>
            <code>
&lt;script src="https://js.stripe.com/v2/"&gt;&lt;/script&gt;
&lt;script&gt;
    Stripe.setPublishableKey('YOUR_PUBLISHABLE_KEY');
&lt;/script&gt;
            </code>
          </pre>
          <p>Not much to say about this, except that nothing will work without it.</p>
          <h4>The Intercept</h4>
          <p>So, now we have an <code>input</code> ready to supply us with a price, we need to write the JavaScript to interrupt this form. There are two commonly used methods to interrupt form submission using JavaScript: <code>preventDefault</code> and <code>return false</code>. You will find many StackOverflow answers claiming that <code>return false</code> will cancel both the default event and event propagation through parent element event listeners, but this applies to <strong>jQuery</strong> events only. In vanilla JavaScript, the story is different. <code>preventDefault</code> successfully prevents the default event (as its name would suggest) while <code>return false</code> prevents neither the event nor propagation. To see the difference, here are two examples to compare: <a href="https://output.jsbin.com/rejili/">Vanilla JavaScript</a> vs <a href="http://jsfiddle.net/jonathon/xty5c/">jQuery</a>. However, when it comes to interrupting form submissions, the two are still more or less interchangeable&mdash;but I strongly advise the use of <code>preventDefault</code> given that it is 2016 and all.</p>
          <pre>
            <code>
&lt;script&gt;
  function stripeResponseHandler(status,response){
    "use strict";
    var paymentForm=document.forms['payform'];
    if (response.error) {
      document.getElementById('feedback').textContent=response.error.message;
      document.getElementById('btnpay').removeAttribute('disabled');
    }
        else
    {
      var dataAmount=document.getElementById('amount');
      var dataEmail=document.getElementById('email');
      var stripeToken=response.id;
      var formString="amount="
          + dataAmount.value
          + "&amp;stripeToken="
          + stripeToken
          + "&amp;email="
          + dataEmail.value;

      function submitForm(f){
        var xhr=new XMLHttpRequest();

        xhr.onload=function(){
          window.location=xhr.responseText;
        }

        xhr.onerror=function(){
          document.getElementById('feedback').textContent="Error";
          console.log(xhr.responseText);
        }
        xhr.open(paymentForm.method,paymentForm.action,true);
        xhr.setRequestHeader('Content-type','application/x-www-form-urlencoded');
        xhr.send(f);
      }

      return submitForm(formString);
    }
  }

  !function(){
    "use strict";
    var paymentForm=document.forms['payform'];

    paymentForm.addEventListener('submit',function(e){
      e.preventDefault();
      var thisForm=this;
      document.getElementById('btnpay').setAttribute('disabled',true);
      var baseAmount=document.getElementById('amountbase').value | 0;
      var amountField=document.getElementById('amount');

      function pound(a){
          return a * 100;
      };

      amountField.value=pound(baseAmount);
      if (amountField.value&gt;0) {
          Stripe.card.createToken(thisForm,stripeResponseHandler);
      }
          else
      {
        alert('Please enter a payment amount');
        document.getElementById('btnpay').removeAttribute('disabled');}
    });
  }();
&lt;/script&gt;
            </code>
          </pre>
          <p>That's probably enough for Part 1. Stay tuned for part 2!</p>
          <p><span class="cursor">&#9608;</span></p>
        </section>
        <footer>
          <a href="https://amdouglas.com/blog/asynchronous-css-the-easy-way/">
            <header>Up next</header>
            <section>
              <h4>Asynchronous CSS: the Easy Way</h4>
              <p>If you've ever looked into asynchronously handling fonts, you've probably read about FilamentGroup's method using link rel=preload, which might look like a hack, but this is actually what the preload spec is for...</p>
              <hr>
              <p><time datetime="2016-09-20 23:32">20 September 2016</time></p>
            </section>
          </a>
          <a href="https://amdouglas.com/blog/lazyloading-css-background-images/">
            <header>Previously</header>
            <section>
              <h4>Lazyloading CSS background-images</h4>
              <p>As a rule, I generally prefer, for the purposes of accessibility and SEO, to use IMG elements to display images over the background-image approach...</p>
              <hr>
              <p><time datetime="2016-08-20 21:35">20 August 2016</time></p>
            </section>
          </a>
        </footer>
      </article>
    </main>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "NewsArticle",
        "mainEntityOfPage": "https://amdouglas.com/blog/stripe-custom-form-in-vanilla-js/",
        "headline": "Stripe Custom Form in Vanilla JS",
        "datePublished": "2016-08-21T21:38:34+00:00",
        "dateModified": "2016-08-21T21:38:34+00:00",
        "description": "Given that it's coming up to Christmas, there obviously couldn't be a more appropriate time to think about adding or customising an e-commerce experience with your own take on the Stripe form",
        "author": {
          "@type": "Person",
          "name": "A. M. Douglas"
        },
        "publisher": {
          "@type": "Organization",
          "name": "A. M. Douglas",
          "logo": {
            "@type": "ImageObject",
            "url": "https://amdouglas.com/assets/img/apple-touch-icon-60x60.png",
            "width": 60,
            "height": 60
          }
        },
        "image": {
          "@type": "ImageObject",
          "url": "https://amdouglas.com/assets/img/apple-touch-icon-60x60.png",
          "height": 60,
          "width": 60
        }
      }
    </script>
    <!--[if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script><![endif]--><!--[if IE]><script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/2014.01.31/classList.min.js"></script><![endif]-->
    <script async defer src="https://amdouglas.com/assets/js/article.js"></script>
  </body>
</html>
